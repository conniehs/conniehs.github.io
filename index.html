<!DOCTYPE html><html lang="en"><head><meta name="x-poe-datastore-behavior" content="local_only"><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RolePlayConvo: Interactive Conversation Practice</title>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&amp;family=Space+Mono:wght@400;700&amp;display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --secondary: #f472b6;
      --accent: #34d399;
      --bg: #fafbff;
      --bg-card: #ffffff;
      --text: #1e1b4b;
      --text-muted: #6b7280;
      --border: #e5e7eb;
      --recording: #ef4444;
      --success: #10b981;
      --gradient-1: linear-gradient(135deg, #6366f1 0%, #a855f7 50%, #f472b6 100%);
      --gradient-2: linear-gradient(135deg, #34d399 0%, #6366f1 100%);
      --shadow: 0 4px 24px rgba(99, 102, 241, 0.15);
      --shadow-lg: 0 8px 40px rgba(99, 102, 241, 0.2);
    }

    .dark {
      --bg: #0f0d1a;
      --bg-card: #1a1725;
      --text: #f8fafc;
      --text-muted: #9ca3af;
      --border: #2d2a3e;
      --shadow: 0 4px 24px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 8px 40px rgba(0, 0, 0, 0.5);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Outfit', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      transition: background 0.3s, color 0.3s;
    }

    .app-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      min-height: 100vh;
    }

    /* Header */
    .header {
      text-align: center;
      padding: 40px 20px;
      position: relative;
    }

    .logo {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .logo-icon {
      width: 56px;
      height: 56px;
      background: var(--gradient-1);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      color: white;
      box-shadow: var(--shadow);
    }

    .logo-text {
      font-size: 28px;
      font-weight: 700;
      background: var(--gradient-1);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .tagline {
      color: var(--text-muted);
      font-size: 18px;
      font-weight: 400;
      max-width: 500px;
      margin: 0 auto;
      line-height: 1.6;
    }

    /* Navigation Buttons */
    .nav-buttons {
      display: flex;
      gap: 16px;
      justify-content: center;
      margin-top: 32px;
      flex-wrap: wrap;
    }

    .nav-btn {
      padding: 16px 32px;
      border: none;
      border-radius: 16px;
      font-family: inherit;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.3s ease;
    }

    .nav-btn.primary {
      background: var(--gradient-1);
      color: white;
      box-shadow: var(--shadow);
    }

    .nav-btn.primary:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .nav-btn.secondary {
      background: var(--bg-card);
      color: var(--text);
      border: 2px solid var(--border);
    }

    .nav-btn.secondary:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    /* Page Sections */
    .page {
      display: none;
      animation: fadeIn 0.4s ease;
    }

    .page.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Session Page */
    .session-container {
      background: var(--bg-card);
      border-radius: 24px;
      padding: 32px;
      box-shadow: var(--shadow);
      margin-top: 24px;
    }

    .session-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 16px;
    }

    .back-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: inherit;
      transition: color 0.2s;
    }

    .back-btn:hover {
      color: var(--primary);
    }

    .session-title {
      font-size: 24px;
      font-weight: 600;
    }

    /* Microphone Status */
    .mic-status {
      padding: 16px 24px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
      font-size: 15px;
    }

    .mic-status.pending {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      color: #92400e;
    }

    .mic-status.granted {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      color: #065f46;
    }

    .mic-status.denied {
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      color: #991b1b;
    }

    .dark .mic-status.pending {
      background: linear-gradient(135deg, #78350f 0%, #92400e 100%);
      color: #fef3c7;
    }

    .dark .mic-status.granted {
      background: linear-gradient(135deg, #064e3b 0%, #065f46 100%);
      color: #d1fae5;
    }

    .dark .mic-status.denied {
      background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%);
      color: #fee2e2;
    }

    /* Recording Area */
    .recording-area {
      text-align: center;
      padding: 40px 20px;
    }

    .record-btn {
      width: 140px;
      height: 140px;
      border-radius: 50%;
      border: none;
      background: var(--gradient-1);
      color: white;
      font-size: 48px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 24px;
      box-shadow: var(--shadow-lg);
      transition: all 0.3s ease;
      position: relative;
    }

    .record-btn:hover:not(:disabled) {
      transform: scale(1.05);
    }

    .record-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .record-btn.recording {
      background: var(--recording);
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
      50% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); }
    }

    .record-instruction {
      color: var(--text-muted);
      font-size: 16px;
      margin-bottom: 16px;
    }

    .timer {
      font-family: 'Space Mono', monospace;
      font-size: 36px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 8px;
    }

    .timer.recording {
      color: var(--recording);
    }

    .timer-label {
      font-size: 14px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* Recorded Message */
    .recorded-feedback {
      background: linear-gradient(135deg, #ddd6fe 0%, #c4b5fd 100%);
      padding: 20px;
      border-radius: 16px;
      margin-top: 24px;
      text-align: center;
    }

    .dark .recorded-feedback {
      background: linear-gradient(135deg, #4c1d95 0%, #5b21b6 100%);
    }

    .recorded-feedback p {
      font-size: 16px;
      color: #5b21b6;
      margin-bottom: 16px;
    }

    .dark .recorded-feedback p {
      color: #e9d5ff;
    }

    /* Playback Controls */
    .playback-controls {
      display: flex;
      justify-content: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .control-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 12px;
      font-family: inherit;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s ease;
    }

    .control-btn.play {
      background: var(--success);
      color: white;
    }

    .control-btn.rerecord {
      background: var(--text-muted);
      color: white;
    }

    .control-btn.download {
      background: var(--primary);
      color: white;
    }

    .control-btn.analyze {
      background: var(--gradient-2);
      color: white;
    }

    .control-btn:hover {
      transform: translateY(-2px);
      opacity: 0.9;
    }

    /* Analysis Section */
    .analysis-section {
      margin-top: 32px;
      padding: 24px;
      background: var(--bg);
      border-radius: 16px;
      border: 2px solid var(--border);
    }

    .analysis-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }

    .analysis-header i {
      font-size: 24px;
      color: var(--primary);
    }

    .analysis-header h3 {
      font-size: 20px;
      font-weight: 600;
    }

    .analysis-loading {
      text-align: center;
      padding: 40px;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .accuracy-display {
      text-align: center;
      margin-bottom: 24px;
    }

    .accuracy-circle {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: var(--gradient-2);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin: 0 auto 12px;
      color: white;
    }

    .accuracy-value {
      font-size: 36px;
      font-weight: 700;
    }

    .accuracy-label {
      font-size: 12px;
      opacity: 0.9;
    }

    .analysis-content {
      display: grid;
      gap: 20px;
    }

    .analysis-card {
      background: var(--bg-card);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .analysis-card h4 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .analysis-card h4 i {
      color: var(--secondary);
    }

    .word-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .word-tag {
      padding: 6px 12px;
      background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);
      color: #9d174d;
      border-radius: 20px;
      font-size: 14px;
    }

    .dark .word-tag {
      background: linear-gradient(135deg, #831843 0%, #9d174d 100%);
      color: #fce7f3;
    }

    .tips-list {
      list-style: none;
    }

    .tips-list li {
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: flex-start;
      gap: 10px;
      font-size: 15px;
      line-height: 1.5;
    }

    .tips-list li:last-child {
      border-bottom: none;
    }

    .tips-list li i {
      color: var(--accent);
      margin-top: 3px;
    }

    /* Recordings Page */
    .recordings-list {
      display: grid;
      gap: 16px;
      margin-top: 24px;
    }

    .recording-item {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 20px;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .recording-icon {
      width: 56px;
      height: 56px;
      background: var(--gradient-1);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
      flex-shrink: 0;
    }

    .recording-info {
      flex: 1;
      min-width: 150px;
    }

    .recording-name {
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 4px;
    }

    .recording-date {
      font-size: 14px;
      color: var(--text-muted);
    }

    .recording-actions {
      display: flex;
      gap: 8px;
    }

    .action-btn {
      width: 40px;
      height: 40px;
      border: none;
      border-radius: 10px;
      background: var(--bg);
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: all 0.2s;
    }

    .action-btn:hover {
      background: var(--primary);
      color: white;
    }

    .action-btn.delete:hover {
      background: var(--recording);
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }

    .empty-state i {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state p {
      font-size: 16px;
    }

    /* Transcription Display */
    .transcription-section {
      margin-top: 24px;
      padding: 20px;
      background: var(--bg);
      border-radius: 12px;
      border: 2px dashed var(--border);
    }

    .transcription-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      font-weight: 600;
    }

    .transcription-header i {
      color: var(--primary);
    }

    .transcription-text {
      font-size: 15px;
      line-height: 1.7;
      color: var(--text);
      white-space: pre-wrap;
    }

    /* Custom Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background: var(--bg-card);
      border-radius: 20px;
      padding: 32px;
      max-width: 400px;
      width: 100%;
      text-align: center;
      transform: scale(0.9);
      transition: transform 0.3s ease;
    }

    .modal-overlay.active .modal-content {
      transform: scale(1);
    }

    .modal-icon {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      font-size: 32px;
    }

    .modal-icon.warning {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      color: #92400e;
    }

    .modal-icon.danger {
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      color: #dc2626;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .modal-message {
      color: var(--text-muted);
      margin-bottom: 24px;
      line-height: 1.5;
    }

    .modal-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .modal-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-family: inherit;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .modal-btn.cancel {
      background: var(--bg);
      color: var(--text-muted);
    }

    .modal-btn.confirm {
      background: var(--recording);
      color: white;
    }

    .modal-btn:hover {
      transform: translateY(-2px);
    }

    /* Responsive */
    @media (max-width: 600px) {
      .header {
        padding: 30px 16px;
      }

      .logo-text {
        font-size: 22px;
      }

      .tagline {
        font-size: 16px;
      }

      .nav-btn {
        width: 100%;
        justify-content: center;
      }

      .session-container {
        padding: 20px;
      }

      .record-btn {
        width: 120px;
        height: 120px;
        font-size: 40px;
      }

      .timer {
        font-size: 28px;
      }

      .control-btn {
        padding: 10px 16px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Home Page -->
    <div id="homePage" class="page active">
      <header class="header">
        <div class="logo">
          <div class="logo-icon">
            <i class="ri-speak-line"></i>
          </div>
          <span class="logo-text">RolePlayConvo</span>
        </div>
        <p class="tagline">Welcome to RolePlayConvo! Enhance your speaking skills through engaging conversations.</p>
        <div class="nav-buttons">
          <button class="nav-btn primary" onclick="startNewConversation()">
            <i class="ri-mic-line"></i>
            Start a New Conversation
          </button>
          <button class="nav-btn secondary" onclick="viewRecordings()">
            <i class="ri-folder-music-line"></i>
            View My Recordings
          </button>
        </div>
      </header>
    </div>

    <!-- Session Page -->
    <div id="sessionPage" class="page">
      <div class="session-container">
        <div class="session-header">
          <button class="back-btn" onclick="goHome()">
            <i class="ri-arrow-left-line"></i>
            Back
          </button>
          <h2 class="session-title">Recording Session</h2>
        </div>

        <div id="micStatus" class="mic-status pending">
          <i class="ri-mic-line"></i>
          <span>Please allow microphone access to record your conversation.</span>
        </div>

        <div class="recording-area">
          <p class="record-instruction">Click the microphone icon to begin recording your conversation.</p>
          <button id="recordBtn" class="record-btn" disabled="" onclick="toggleRecording()">
            <i class="ri-mic-fill"></i>
          </button>
          <div id="timerDisplay" class="timer">00:00</div>
          <div class="timer-label">Recording Duration</div>
        </div>

        <div id="recordedFeedback" class="recorded-feedback" style="display: none;">
          <p><i class="ri-checkbox-circle-fill"></i> Your conversation has been recorded! Would you like to play it back?</p>
          <div class="playback-controls">
            <button class="control-btn play" onclick="playRecording()">
              <i class="ri-play-fill"></i>
              Play
            </button>
            <button class="control-btn rerecord" onclick="reRecord()">
              <i class="ri-refresh-line"></i>
              Re-record
            </button>
            <button class="control-btn download" onclick="downloadRecording()">
              <i class="ri-download-line"></i>
              Download
            </button>
            <button class="control-btn analyze" onclick="analyzeRecording()">
              <i class="ri-brain-line"></i>
              Analyze
            </button>
          </div>
        </div>

        <!-- Transcription -->
        <div id="transcriptionSection" class="transcription-section" style="display: none;">
          <div class="transcription-header">
            <i class="ri-file-text-line"></i>
            <span>Transcription</span>
          </div>
          <div id="transcriptionText" class="transcription-text"></div>
        </div>

        <!-- Analysis Section -->
        <div id="analysisSection" class="analysis-section" style="display: none;">
          <div class="analysis-header">
            <i class="ri-pie-chart-line"></i>
            <h3>Pronunciation Analysis</h3>
          </div>
          <div id="analysisContent">
            <div class="analysis-loading">
              <div class="spinner"></div>
              <p>Analyzing your pronunciation...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Recordings Page -->
    <div id="recordingsPage" class="page">
      <div class="session-container">
        <div class="session-header">
          <button class="back-btn" onclick="goHome()">
            <i class="ri-arrow-left-line"></i>
            Back
          </button>
          <h2 class="session-title">My Recordings</h2>
        </div>

        <p style="color: var(--text-muted); margin-bottom: 16px;">
          <i class="ri-headphone-line"></i> Listen to your recordings to identify areas for improvement.
        </p>

        <div id="recordingsList" class="recordings-list">
          <!-- Recordings will be populated here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal-overlay">
    <div class="modal-content">
      <div id="modalIcon" class="modal-icon warning">
        <i class="ri-alert-line"></i>
      </div>
      <h3 id="modalTitle" class="modal-title">Confirm Action</h3>
      <p id="modalMessage" class="modal-message">Are you sure you want to proceed?</p>
      <div class="modal-buttons">
        <button class="modal-btn cancel" onclick="closeModal()">Cancel</button>
        <button id="modalConfirm" class="modal-btn confirm">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Hidden audio element for playback -->
  <audio id="audioPlayer" style="display: none;"></audio>

  <script>
    // Dark mode detection
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.documentElement.classList.add('dark');
    }
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
      if (event.matches) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    });

    // State
    let mediaRecorder = null;
    let audioChunks = [];
    let isRecording = false;
    let timerInterval = null;
    let recordingSeconds = 0;
    let currentAudioBlob = null;
    let currentAudioFile = null;
    let recordings = [];
    let currentTranscription = '';
    let modalCallback = null;

    // DOM Elements
    const recordBtn = document.getElementById('recordBtn');
    const timerDisplay = document.getElementById('timerDisplay');
    const micStatus = document.getElementById('micStatus');
    const recordedFeedback = document.getElementById('recordedFeedback');
    const audioPlayer = document.getElementById('audioPlayer');
    const analysisSection = document.getElementById('analysisSection');
    const analysisContent = document.getElementById('analysisContent');
    const transcriptionSection = document.getElementById('transcriptionSection');
    const transcriptionText = document.getElementById('transcriptionText');

    // Navigation
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById(pageId).classList.add('active');
    }

    function goHome() {
      showPage('homePage');
      resetSession();
    }

    function startNewConversation() {
      showPage('sessionPage');
      requestMicrophoneAccess();
    }

    function viewRecordings() {
      showPage('recordingsPage');
      renderRecordingsList();
    }

    // Microphone Access
    async function requestMicrophoneAccess() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        micStatus.className = 'mic-status granted';
        micStatus.innerHTML = '<i class="ri-checkbox-circle-fill"></i><span>Microphone access granted! You are ready to record.</span>';
        recordBtn.disabled = false;

        // Setup MediaRecorder
        mediaRecorder = new MediaRecorder(stream);

        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) {
            audioChunks.push(event.data);
          }
        };

        mediaRecorder.onstop = () => {
          currentAudioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          currentAudioFile = new File([currentAudioBlob], `recording_${Date.now()}.webm`, { type: 'audio/webm' });
          audioPlayer.src = URL.createObjectURL(currentAudioBlob);
          recordedFeedback.style.display = 'block';

          // Save recording
          const recording = {
            id: Date.now(),
            name: `Recording ${recordings.length + 1}`,
            date: new Date().toLocaleDateString('en-US', {
              month: 'short',
              day: 'numeric',
              year: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            }),
            duration: formatTime(recordingSeconds),
            blob: currentAudioBlob
          };
          recordings.unshift(recording);
        };

      } catch (err) {
        console.error('Microphone access denied:', JSON.stringify(err));
        micStatus.className = 'mic-status denied';
        micStatus.innerHTML = '<i class="ri-close-circle-fill"></i><span>Microphone access denied. Please enable it in your browser settings.</span>';
      }
    }

    // Recording Controls
    function toggleRecording() {
      if (!isRecording) {
        startRecording();
      } else {
        stopRecording();
      }
    }

    function startRecording() {
      audioChunks = [];
      recordingSeconds = 0;
      currentTranscription = '';

      mediaRecorder.start();
      isRecording = true;

      recordBtn.classList.add('recording');
      recordBtn.innerHTML = '<i class="ri-stop-fill"></i>';
      timerDisplay.classList.add('recording');
      recordedFeedback.style.display = 'none';
      analysisSection.style.display = 'none';
      transcriptionSection.style.display = 'none';

      timerInterval = setInterval(() => {
        recordingSeconds++;
        timerDisplay.textContent = formatTime(recordingSeconds);
      }, 1000);
    }

    function stopRecording() {
      mediaRecorder.stop();
      isRecording = false;

      clearInterval(timerInterval);
      recordBtn.classList.remove('recording');
      recordBtn.innerHTML = '<i class="ri-mic-fill"></i>';
      timerDisplay.classList.remove('recording');
    }

    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    // Playback Controls
    function playRecording() {
      if (audioPlayer.paused) {
        audioPlayer.play();
      } else {
        audioPlayer.pause();
        audioPlayer.currentTime = 0;
      }
    }

    function reRecord() {
      showModal(
        'Re-record?',
        'This will discard your current recording. Are you sure?',
        'warning',
        () => {
          resetRecording();
          startRecording();
        }
      );
    }

    function resetRecording() {
      recordedFeedback.style.display = 'none';
      analysisSection.style.display = 'none';
      transcriptionSection.style.display = 'none';
      timerDisplay.textContent = '00:00';
      currentAudioBlob = null;
      currentAudioFile = null;
      currentTranscription = '';
    }

    function resetSession() {
      stopRecordingIfActive();
      resetRecording();
      recordingSeconds = 0;
    }

    function stopRecordingIfActive() {
      if (isRecording) {
        mediaRecorder.stop();
        isRecording = false;
        clearInterval(timerInterval);
        recordBtn.classList.remove('recording');
        recordBtn.innerHTML = '<i class="ri-mic-fill"></i>';
        timerDisplay.classList.remove('recording');
      }
    }

    function downloadRecording() {
      if (!currentAudioBlob) return;

      const url = URL.createObjectURL(currentAudioBlob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `roleplay_recording_${Date.now()}.webm`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Analysis
    async function analyzeRecording() {
      if (!currentAudioFile) return;

      analysisSection.style.display = 'block';
      analysisContent.innerHTML = '<div class="analysis-loading"><div class="spinner"></div><p>Transcribing your recording...</p></div>';

      // Register handler for transcription
      window.Poe.registerHandler('transcription-handler', async (result) => {
        const msg = result.responses[0];

        if (msg.status === 'error') {
          analysisContent.innerHTML = `<p style="color: var(--recording);">Error: ${msg.statusText || 'Failed to transcribe audio'}</p>`;
          return;
        }

        if (msg.status === 'complete') {
          currentTranscription = msg.content;

          // Show transcription
          transcriptionSection.style.display = 'block';
          transcriptionText.textContent = currentTranscription;

          // Now analyze pronunciation
          analysisContent.innerHTML = '<div class="analysis-loading"><div class="spinner"></div><p>Analyzing pronunciation...</p></div>';
          analyzeWithAI(currentTranscription);
        }
      });

      // Send to Whisper for transcription
      try {
        await window.Poe.sendUserMessage('@Whisper-V3-Large-T Please transcribe this audio recording.', {
          attachments: [currentAudioFile],
          handler: 'transcription-handler',
          stream: false,
          openChat: false
        });
      } catch (err) {
        console.error('Transcription error:', JSON.stringify(err));
        analysisContent.innerHTML = `<p style="color: var(--recording);">Error: ${err.message || 'Failed to start transcription'}</p>`;
      }
    }

    async function analyzeWithAI(transcription) {
      // Register handler for analysis
      window.Poe.registerHandler('analysis-handler', (result) => {
        const msg = result.responses[0];

        if (msg.status === 'error') {
          analysisContent.innerHTML = `<p style="color: var(--recording);">Error: ${msg.statusText || 'Failed to analyze'}</p>`;
          return;
        }

        if (msg.status === 'complete') {
          try {
            const analysis = JSON.parse(msg.content);
            displayAnalysis(analysis);
          } catch (e) {
            console.error('Parse error:', JSON.stringify(e));
            // Try to extract JSON from response
            const jsonMatch = msg.content.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
              try {
                const analysis = JSON.parse(jsonMatch[0]);
                displayAnalysis(analysis);
              } catch (e2) {
                analysisContent.innerHTML = `<p style="color: var(--recording);">Could not parse analysis results.</p>`;
              }
            } else {
              analysisContent.innerHTML = `<p style="color: var(--recording);">Could not parse analysis results.</p>`;
            }
          }
        }
      });

      const prompt = `@Grok-4.1-Fast-Non-Reasoning You are a pronunciation analysis assistant. Analyze the following transcription from a student's speaking practice and provide feedback. Return ONLY a JSON object with no additional text.

Transcription: "${transcription}"

Return this exact JSON structure:
{
  "accuracyRate": <number 0-100>,
  "incorrectWords": [<list of words that might be mispronounced based on context>],
  "practicePhrase": [<3-5 phrases to practice>],
  "tips": [<3-4 improvement tips>]
}

Be encouraging but helpful. If the transcription is clear, give a high accuracy rate. Focus on common pronunciation challenges.`;

      try {
        await window.Poe.sendUserMessage(prompt, {
          handler: 'analysis-handler',
          stream: false,
          openChat: false
        });
      } catch (err) {
        console.error('Analysis error:', JSON.stringify(err));
        analysisContent.innerHTML = `<p style="color: var(--recording);">Error: ${err.message || 'Failed to analyze'}</p>`;
      }
    }

    function displayAnalysis(analysis) {
      const { accuracyRate, incorrectWords, practicePhrase, tips } = analysis;

      analysisContent.innerHTML = `
        <div class="accuracy-display">
          <div class="accuracy-circle">
            <span class="accuracy-value">${accuracyRate}%</span>
            <span class="accuracy-label">Accuracy</span>
          </div>
          <p style="color: var(--text-muted);">Your pronunciation accuracy rate</p>
        </div>

        <div class="analysis-content">
          ${incorrectWords && incorrectWords.length > 0 ? `
          <div class="analysis-card">
            <h4><i class="ri-error-warning-line"></i> Words to Practice</h4>
            <div class="word-list">
              ${incorrectWords.map(word => `<span class="word-tag">${word}</span>`).join('')}
            </div>
          </div>
          ` : ''}

          ${practicePhrase && practicePhrase.length > 0 ? `
          <div class="analysis-card">
            <h4><i class="ri-book-open-line"></i> Practice Phrases</h4>
            <ul class="tips-list">
              ${practicePhrase.map(phrase => `<li><i class="ri-double-quotes-l"></i> ${phrase}</li>`).join('')}
            </ul>
          </div>
          ` : ''}

          ${tips && tips.length > 0 ? `
          <div class="analysis-card">
            <h4><i class="ri-lightbulb-line"></i> Improvement Tips</h4>
            <ul class="tips-list">
              ${tips.map(tip => `<li><i class="ri-check-line"></i> ${tip}</li>`).join('')}
            </ul>
          </div>
          ` : ''}
        </div>
      `;
    }

    // Recordings List
    function renderRecordingsList() {
      const list = document.getElementById('recordingsList');

      if (recordings.length === 0) {
        list.innerHTML = `
          <div class="empty-state">
            <i class="ri-folder-music-line"></i>
            <p>No recordings yet. Start a new conversation to create your first recording!</p>
          </div>
        `;
        return;
      }

      list.innerHTML = recordings.map(rec => `
        <div class="recording-item" data-id="${rec.id}">
          <div class="recording-icon">
            <i class="ri-mic-fill"></i>
          </div>
          <div class="recording-info">
            <div class="recording-name">${rec.name}</div>
            <div class="recording-date">${rec.date} â€¢ ${rec.duration}</div>
          </div>
          <div class="recording-actions">
            <button class="action-btn" onclick="playRecordingById(${rec.id})" title="Play">
              <i class="ri-play-fill"></i>
            </button>
            <button class="action-btn" onclick="downloadRecordingById(${rec.id})" title="Download">
              <i class="ri-download-line"></i>
            </button>
            <button class="action-btn delete" onclick="deleteRecording(${rec.id})" title="Delete">
              <i class="ri-delete-bin-line"></i>
            </button>
          </div>
        </div>
      `).join('');
    }

    function playRecordingById(id) {
      const rec = recordings.find(r => r.id === id);
      if (rec && rec.blob) {
        audioPlayer.src = URL.createObjectURL(rec.blob);
        audioPlayer.play();
      }
    }

    function downloadRecordingById(id) {
      const rec = recordings.find(r => r.id === id);
      if (rec && rec.blob) {
        const url = URL.createObjectURL(rec.blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${rec.name.replace(/\s+/g, '_')}.webm`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }
    }

    function deleteRecording(id) {
      showModal(
        'Delete Recording?',
        'This action cannot be undone. Are you sure you want to delete this recording?',
        'danger',
        () => {
          recordings = recordings.filter(r => r.id !== id);
          renderRecordingsList();
        }
      );
    }

    // Modal
    function showModal(title, message, type, callback) {
      const modal = document.getElementById('modal');
      const modalIcon = document.getElementById('modalIcon');
      const modalTitle = document.getElementById('modalTitle');
      const modalMessage = document.getElementById('modalMessage');
      const modalConfirm = document.getElementById('modalConfirm');

      modalTitle.textContent = title;
      modalMessage.textContent = message;
      modalIcon.className = `modal-icon ${type}`;
      modalIcon.innerHTML = type === 'danger' ? '<i class="ri-delete-bin-line"></i>' : '<i class="ri-alert-line"></i>';

      modalCallback = callback;
      modalConfirm.onclick = () => {
        closeModal();
        if (modalCallback) modalCallback();
      };

      modal.classList.add('active');
    }

    function closeModal() {
      document.getElementById('modal').classList.remove('active');
      modalCallback = null;
    }

    // Close modal on overlay click
    document.getElementById('modal').addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-overlay')) {
        closeModal();
      }
    });
  </script>


</body></html>