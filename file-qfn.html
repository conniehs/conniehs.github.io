<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RolePlayConvo: Interactive Conversation Practice</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');

        :root {
            --primary-dark: #300060; /* Deep Indigo */
            --primary-light: #6000c0; /* Lighter Purple */
            --accent-coral: #FF6F61; /* Warm Coral */
            --text-light: #F8F8F8; /* Soft White */
            --text-dark: #333; /* Dark Gray */
            --bg-gray: #EFEFEF; /* Soft Gray Background */
            --border-gray: #DDD;
            --gradient-start: #6000c0;
            --gradient-end: #300060;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Poppins', sans-serif;
        }

        body {
            line-height: 1.6;
            color: var(--text-dark);
            background-color: var(--bg-gray);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            scroll-behavior: smooth;
        }

        h1, h2, h3 {
            color: var(--primary-dark);
            margin-bottom: 0.8em;
        }

        h1 { font-size: 2.5em; }
        h2 { font-size: 2em; }
        h3 { font-size: 1.5em; }

        section {
            padding: 3rem 1rem;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
            background-color: var(--text-light);
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }

        section.active {
            opacity: 1;
            transform: translateY(0);
        }

        /* Homepage Hero */
        #homepage {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: var(--text-light);
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 2rem;
            border-radius: 0; /* Override section border-radius */
            box-shadow: none; /* Override section box-shadow */
            opacity: 1; /* Always active */
            transform: translateY(0);
        }

        #homepage h1 {
            color: var(--text-light);
            font-size: 3em;
            margin-bottom: 0.5em;
            letter-spacing: 1px;
        }

        #homepage .hero-buttons {
            display: flex;
            gap: 1.5rem;
            margin-top: 2rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* Buttons */
        .btn {
            display: inline-block;
            padding: 0.8em 1.5em;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            border: none;
            font-size: 1em;
            text-align: center;
        }

        .btn-primary {
            background-color: var(--accent-coral);
            color: var(--text-light);
            box-shadow: 0 4px 10px rgba(255, 111, 97, 0.4);
        }

        .btn-primary:hover {
            background-color: #e65c50;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(255, 111, 97, 0.5);
        }

        .btn-secondary {
            background-color: var(--primary-light);
            color: var(--text-light);
            box-shadow: 0 4px 10px rgba(96, 0, 192, 0.3);
        }

        .btn-secondary:hover {
            background-color: #5000a0;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(96, 0, 192, 0.4);
        }

        .btn-small {
            padding: 0.5em 1em;
            font-size: 0.9em;
            border-radius: 25px;
        }

        /* Form elements */
        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--primary-dark);
        }

        input[type="file"],
        textarea {
            width: 100%;
            padding: 0.8em;
            border: 1px solid var(--border-gray);
            border-radius: 5px;
            font-size: 1em;
            color: var(--text-dark);
            background-color: var(--bg-gray);
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        input[type="file"]:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 2px rgba(96, 0, 192, 0.2);
        }

        textarea {
            min-height: 150px;
        }

        .message {
            margin-top: 1rem;
            padding: 0.8em 1em;
            border-radius: 5px;
            font-weight: 600;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.4s ease, transform 0.4s ease;
            will-change: opacity, transform;
        }

        .message.show {
            opacity: 1;
            transform: translateY(0);
        }

        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Recording Studio */
        #recording-studio {
            text-align: center;
        }

        .microphone-btn {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: var(--accent-coral);
            color: var(--text-light);
            font-size: 3em;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 2rem auto;
            cursor: pointer;
            border: none;
            box-shadow: 0 8px 20px rgba(255, 111, 97, 0.4);
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .microphone-btn:hover {
            background-color: #e65c50;
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(255, 111, 97, 0.5);
        }

        .microphone-btn.recording {
            background-color: #e65c50;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 111, 97, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(255, 111, 97, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 111, 97, 0); }
        }

        .waveform-visualizer {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            height: 50px;
            margin-top: 1rem;
            gap: 2px;
            border-bottom: 2px solid var(--border-gray);
        }

        .waveform-bar {
            width: 4px;
            background-color: var(--primary-light);
            height: 5px; /* Base height */
            transition: height 0.1s ease-out;
            border-radius: 2px 2px 0 0;
        }

        .recording-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .recording-controls .btn {
            padding: 0.7em 1.2em;
            font-size: 0.95em;
        }

        .recording-timer {
            font-size: 1.8em;
            font-weight: 600;
            color: var(--primary-dark);
            margin-top: 1rem;
        }

        /* Pronunciation Analysis */
        #pronunciation-analysis .score-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .score-card {
            background-color: var(--bg-gray);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .score-card h3 {
            margin-top: 0;
            margin-bottom: 0.5rem;
            color: var(--primary-light);
        }

        .score-card .percentage {
            font-size: 2.5em;
            font-weight: 700;
            color: var(--accent-coral);
        }

        .incorrect-words-list {
            margin-top: 1.5rem;
        }

        .incorrect-words-list ul {
            list-style: none;
            padding: 0;
            display: flex;
            flex-wrap: wrap;
            gap: 0.8rem;
            justify-content: center;
        }

        .incorrect-words-list li {
            background-color: var(--primary-light);
            color: var(--text-light);
            padding: 0.5em 1em;
            border-radius: 25px;
            display: flex;
            align-items: center;
            gap: 0.5em;
            font-weight: 500;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .incorrect-words-list li button {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 1.2em;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            transition: transform 0.2s ease;
        }

        .incorrect-words-list li button:hover {
            transform: scale(1.1);
        }

        /* Recordings Library */
        #recordings-library table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
            background-color: var(--text-light);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border-radius: 8px;
            overflow: hidden; /* Ensures rounded corners */
        }

        #recordings-library th,
        #recordings-library td {
            padding: 0.8em 1em;
            text-align: left;
            border-bottom: 1px solid var(--border-gray);
        }

        #recordings-library th {
            background-color: var(--primary-dark);
            color: var(--text-light);
            font-weight: 600;
        }

        #recordings-library tr:last-child td {
            border-bottom: none;
        }

        #recordings-library tr:nth-child(even) {
            background-color: var(--bg-gray);
        }

        #recordings-library td .btn-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        #recordings-library td .btn-group .btn {
            padding: 0.4em 0.8em;
            font-size: 0.85em;
        }

        #recordings-library td .btn-play {
            background-color: #28a745;
        }
        #recordings-library td .btn-play:hover {
            background-color: #218838;
        }

        #recordings-library td .btn-analyze {
            background-color: var(--primary-light);
        }
        #recordings-library td .btn-analyze:hover {
            background-color: #5000a0;
        }

        #recordings-library td .btn-delete {
            background-color: #dc3545;
        }
        #recordings-library td .btn-delete:hover {
            background-color: #c82333;
        }

        .no-recordings {
            text-align: center;
            margin-top: 2rem;
            font-style: italic;
            color: var(--text-dark);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            h1 { font-size: 2em; }
            h2 { font-size: 1.7em; }
            section { padding: 2rem 0.8rem; }
            #homepage h1 { font-size: 2.5em; }
            #homepage .hero-buttons { flex-direction: column; }
            .btn { width: 100%; max-width: 300px; }
            .microphone-btn { width: 80px; height: 80px; font-size: 2.5em; }
            .recording-controls { flex-direction: column; }
            .recording-controls .btn { width: 100%; max-width: 250px; margin: 0 auto; }
            #recordings-library table { font-size: 0.9em; }
            #recordings-library th, #recordings-library td { padding: 0.6em 0.8em; }
            .score-card .percentage { font-size: 2em; }
        }

        @media (max-width: 480px) {
            #homepage h1 { font-size: 2em; }
            .hero-buttons .btn { font-size: 0.9em; padding: 0.7em 1em; }
            .incorrect-words-list li { font-size: 0.9em; }
        }
    </style>
</head>
<body>

    <section id="homepage" class="active">
        <h1>Welcome to RolePlayConvo!</h1>
        <p>Enhance your speaking skills through engaging conversations.</p>
        <div class="hero-buttons">
            <a href="#script-upload" class="btn btn-primary" onclick="showSection('script-upload');">Start New Conversation</a>
            <a href="#recordings-library" class="btn btn-secondary" onclick="showSection('recordings-library');">View My Recordings</a>
        </div>
    </section>

    <section id="script-upload">
        <h2>1. Script Upload</h2>
        <div class="form-group">
            <label for="scriptFileInput">Upload your conversation script (.txt)</label>
            <input type="file" id="scriptFileInput" accept=".txt">
        </div>
        <div class="form-group">
            <label for="scriptPreview">Script Content Preview</label>
            <textarea id="scriptPreview" placeholder="Your script will appear here..."></textarea>
        </div>
        <button id="saveScriptBtn" class="btn btn-primary">Save Script & Continue</button>
        <div id="scriptMessage" class="message"></div>
    </section>

    <section id="recording-studio">
        <h2>2. Recording Studio</h2>
        <div class="recording-status-message">Allow microphone access</div>
        <button id="microphoneBtn" class="microphone-btn"><i class="fas fa-microphone"></i></button>
        <div class="waveform-visualizer" id="waveformVisualizer"></div>
        <div class="recording-timer" id="recordingTimer">00:00</div>
        <div class="recording-controls">
            <button id="recordStopBtn" class="btn btn-primary">Record</button>
            <button id="playRecordingBtn" class="btn btn-secondary" disabled>Play</button>
            <button id="reRecordBtn" class="btn btn-secondary" disabled>Re-record</button>
            <button id="downloadMp3Btn" class="btn btn-secondary" disabled>Download MP3</button>
        </div>
    </section>

    <section id="pronunciation-analysis">
        <h2>3. Pronunciation Analysis</h2>
        <p class="pronunciation-intro-message">Record your conversation to see detailed analysis here!</p>
        <div id="analysis-content" style="display: none;">
            <div class="score-grid">
                <div class="score-card">
                    <h3>Combined Accuracy</h3>
                    <div class="percentage" id="combinedAccuracy">--%</div>
                </div>
                <div class="score-card">
                    <h3>Student A</h3>
                    <div class="percentage" id="studentAAccuracy">--%</div>
                </div>
                <div class="score-card">
                    <h3>Student B</h3>
                    <div class="percentage" id="studentBAccuracy">--%</div>
                </div>
            </div>

            <h3>Incorrect Words (Click to hear correct UK pronunciation)</h3>
            <div class="incorrect-words-list">
                <ul id="incorrectWordsList">
                    <!-- Incorrect words will be dynamically added here -->
                </ul>
            </div>
            <p style="text-align: center; margin-top: 2rem;">
                <button class="btn btn-secondary" onclick="showSection('recording-studio');">Back to Recording</button>
                <button class="btn btn-primary" onclick="saveCurrentRecording();">Save Recording & Analysis</button>
            </p>
        </div>
    </section>

    <section id="recordings-library">
        <h2>4. Recordings Library</h2>
        <div class="no-recordings" id="noRecordingsMessage">No recordings yet. Start a new conversation!</div>
        <table id="recordingsTable" style="display: none;">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Duration</th>
                    <th>A%</th>
                    <th>B%</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- Recordings will be dynamically loaded here -->
            </tbody>
        </table>
    </section>

    <!-- Font Awesome for Icons -->
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

    <script>
        const SCRIPT_STORAGE_KEY = 'roleplayconvo_script';
        const RECORDINGS_STORAGE_KEY = 'roleplayconvo_recordings';
        const SYNTHESIS_VOICE = 'Google UK English Male'; // Or 'Google UK English Female', check available voices

        // --- DOM Elements ---
        const homepageSection = document.getElementById('homepage');
        const scriptUploadSection = document.getElementById('script-upload');
        const recordingStudioSection = document.getElementById('recording-studio');
        const pronunciationAnalysisSection = document.getElementById('pronunciation-analysis');
        const recordingsLibrarySection = document.getElementById('recordings-library');

        const scriptFileInput = document.getElementById('scriptFileInput');
        const scriptPreview = document.getElementById('scriptPreview');
        const saveScriptBtn = document.getElementById('saveScriptBtn');
        const scriptMessage = document.getElementById('scriptMessage');

        const microphoneBtn = document.getElementById('microphoneBtn');
        const recordingStatusMessage = document.querySelector('.recording-status-message');
        const waveformVisualizer = document.getElementById('waveformVisualizer');
        const recordingTimer = document.getElementById('recordingTimer');
        const recordStopBtn = document.getElementById('recordStopBtn');
        const playRecordingBtn = document.getElementById('playRecordingBtn');
        const reRecordBtn = document.getElementById('reRecordBtn');
        const downloadMp3Btn = document.getElementById('downloadMp3Btn');

        const pronunciationIntroMessage = document.querySelector('.pronunciation-intro-message');
        const analysisContent = document.getElementById('analysis-content');
        const combinedAccuracy = document.getElementById('combinedAccuracy');
        const studentAAccuracy = document.getElementById('studentAAccuracy');
        const studentBAccuracy = document.getElementById('studentBAccuracy');
        const incorrectWordsList = document.getElementById('incorrectWordsList');

        const noRecordingsMessage = document.getElementById('noRecordingsMessage');
        const recordingsTable = document.getElementById('recordingsTable');
        const recordingsTableBody = recordingsTable.querySelector('tbody');

        // --- Global State Variables ---
        let currentScript = '';
        let mediaRecorder;
        let audioChunks = [];
        let audioBlob;
        let audioUrl;
        let timerInterval;
        let seconds = 0;
        let currentRecordingAnalysis = null; // Stores analysis data for the current recording session

        let audioContext;
        let analyser;
        let source;
        let waveformBars = [];
        const NUM_WAVEFORM_BARS = 20;

        // --- Utility Functions ---

        function showMessage(element, msg, type = 'success') {
            element.textContent = msg;
            element.className = `message ${type} show`;
            setTimeout(() => {
                element.classList.remove('show');
            }, 3000);
        }

        function formatTime(sec) {
            const minutes = Math.floor(sec / 60);
            const remainingSeconds = sec % 60;
            return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        function showSection(id) {
            const sections = document.querySelectorAll('section');
            sections.forEach(section => {
                section.classList.remove('active');
            });
            const targetSection = document.getElementById(id);
            if (targetSection) {
                targetSection.classList.add('active');
                targetSection.scrollIntoView({ behavior: 'smooth' });
            }
            if (id === 'recordings-library') {
                loadRecordings();
            }
        }

        // --- Script Upload Logic ---

        scriptFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    scriptPreview.value = e.target.result;
                    currentScript = e.target.result;
                };
                reader.readAsText(file);
            } else {
                scriptPreview.value = '';
                currentScript = '';
            }
        });

        saveScriptBtn.addEventListener('click', () => {
            if (scriptPreview.value.trim() === '') {
                showMessage(scriptMessage, 'Please upload or type a script.', 'error');
                return;
            }
            currentScript = scriptPreview.value.trim();
            localStorage.setItem(SCRIPT_STORAGE_KEY, currentScript);
            showMessage(scriptMessage, 'Script saved! Ready for recording.', 'success');
            setTimeout(() => showSection('recording-studio'), 1500);
        });

        function loadScript() {
            const savedScript = localStorage.getItem(SCRIPT_STORAGE_KEY);
            if (savedScript) {
                scriptPreview.value = savedScript;
                currentScript = savedScript;
            } else {
                scriptPreview.value = 'Hello! How are you today?\nI\'m doing great, thanks! And you?\nI\'m good too. What are your plans for the weekend?';
                currentScript = scriptPreview.value;
                localStorage.setItem(SCRIPT_STORAGE_KEY, currentScript); // Save default script
            }
        }

        // --- Recording Studio Logic ---

        function initWaveformVisualizer() {
            waveformVisualizer.innerHTML = ''; // Clear previous bars
            for (let i = 0; i < NUM_WAVEFORM_BARS; i++) {
                const bar = document.createElement('div');
                bar.classList.add('waveform-bar');
                waveformVisualizer.appendChild(bar);
                waveformBars.push(bar);
            }
        }

        function visualizeAudio() {
            requestAnimationFrame(visualizeAudio);
            if (!analyser) return;

            const bufferLength = analyser.frequencyBinData.length;
            const dataArray = new Uint8Array(bufferLength);
            analyser.getByteFrequencyData(dataArray);

            for (let i = 0; i < NUM_WAVEFORM_BARS; i++) {
                const barHeight = dataArray[i] / 255 * 50; // Scale to 50px max height
                waveformBars[i].style.height = `${barHeight}px`;
            }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                recordingStatusMessage.textContent = 'Ready to record!';
                microphoneBtn.classList.remove('recording');
                recordStopBtn.textContent = 'Record';
                recordStopBtn.disabled = false;
                playRecordingBtn.disabled = true;
                reRecordBtn.disabled = true;
                downloadMp3Btn.disabled = true;

                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                seconds = 0;
                recordingTimer.textContent = '00:00';

                // Web Audio API for waveform
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256; // Smaller FFT for faster processing
                const bufferLength = analyser.frequencyBinData.length;
                const dataArray = new Uint8Array(bufferLength); // To hold frequency data

                source = audioContext.createMediaStreamSource(stream);
                source.connect(analyser);
                // analyser.connect(audioContext.destination); // Connect to speakers if you want to hear it live
                initWaveformVisualizer();
                visualizeAudio(); // Start visualizer

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    audioBlob = new Blob(audioChunks, { type: 'audio/mpeg' });
                    audioUrl = URL.createObjectURL(audioBlob);

                    playRecordingBtn.disabled = false;
                    reRecordBtn.disabled = false;
                    downloadMp3Btn.disabled = false;

                    stream.getTracks().forEach(track => track.stop()); // Stop microphone
                    if (source) source.disconnect();
                    if (audioContext) audioContext.close();
                };

            } catch (err) {
                console.error('Error accessing microphone:', err);
                recordingStatusMessage.textContent = 'Error: Microphone access denied or unavailable.';
                showMessage(scriptMessage, 'Error: Microphone access denied or unavailable.', 'error');
                recordStopBtn.disabled = true;
            }
        }

        microphoneBtn.addEventListener('click', () => {
            // This button primarily serves as a visual indicator and to trigger initial mic access.
            // The actual recording starts/stops with recordStopBtn.
            if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                startRecording();
            }
        });

        recordStopBtn.addEventListener('click', () => {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                clearInterval(timerInterval);
                microphoneBtn.classList.remove('recording');
                recordStopBtn.textContent = 'Record';
                recordingStatusMessage.textContent = 'Recording stopped.';
                generatePronunciationAnalysis();
                showSection('pronunciation-analysis'); // Go to analysis after stopping
            } else if (mediaRecorder && mediaRecorder.state === 'inactive') {
                audioChunks = []; // Clear previous chunks for a new recording
                mediaRecorder.start();
                microphoneBtn.classList.add('recording');
                recordStopBtn.textContent = 'Stop';
                recordingStatusMessage.textContent = 'Recording:';
                seconds = 0;
                recordingTimer.textContent = '00:00';
                timerInterval = setInterval(() => {
                    seconds++;
                    recordingTimer.textContent = formatTime(seconds);
                }, 1000);
            } else {
                // Initial state, or re-record triggered without starting mic
                startRecording().then(() => {
                    // Start recording immediately after getting stream
                    if (mediaRecorder && mediaRecorder.state === 'inactive') {
                        mediaRecorder.start();
                        microphoneBtn.classList.add('recording');
                        recordStopBtn.textContent = 'Stop';
                        recordingStatusMessage.textContent = 'Recording:';
                        seconds = 0;
                        recordingTimer.textContent = '00:00';
                        timerInterval = setInterval(() => {
                            seconds++;
                            recordingTimer.textContent = formatTime(seconds);
                        }, 1000);
                    }
                });
            }
        });

        playRecordingBtn.addEventListener('click', () => {
            if (audioUrl) {
                const audio = new Audio(audioUrl);
                audio.play();
            }
        });

        reRecordBtn.addEventListener('click', () => {
            clearInterval(timerInterval);
            seconds = 0;
            recordingTimer.textContent = '00:00';
            audioChunks = [];
            audioBlob = null;
            audioUrl = null;
            playRecordingBtn.disabled = true;
            reRecordBtn.disabled = true;
            downloadMp3Btn.disabled = true;
            recordStopBtn.textContent = 'Record';
            microphoneBtn.classList.remove('recording');
            recordingStatusMessage.textContent = 'Ready to record!';
            startRecording(); // Re-initialize mediaRecorder
        });

        downloadMp3Btn.addEventListener('click', () => {
            if (audioBlob) {
                const a = document.createElement('a');
                document.body.appendChild(a);
                a.style = 'display: none';
                a.href = audioUrl;
                a.download = `RolePlayConvo_${new Date().toISOString().slice(0,10)}.mp3`;
                a.click();
                window.URL.revokeObjectURL(audioUrl);
            }
        });


        // --- Pronunciation Analysis Logic (Mock Data) ---

        const speechSynth = window.speechSynthesis;
        let ukVoice = null;

        function populateVoices() {
            const voices = speechSynth.getVoices();
            ukVoice = voices.find(voice => voice.name === SYNTHESIS_VOICE);
            if (!ukVoice) {
                console.warn(`UK English voice "${SYNTHESIS_VOICE}" not found, falling back to default.`);
                ukVoice = voices.find(voice => voice.lang === 'en-GB') || voices[0];
            }
        }
        populateVoices();
        if (speechSynth.onvoiceschanged !== undefined) {
            speechSynth.onvoiceschanged = populateVoices;
        }

        function speakWord(word) {
            if (speechSynth.speaking) {
                speechSynth.cancel();
            }
            const utterance = new SpeechSynthesisUtterance(word);
            utterance.voice = ukVoice;
            utterance.lang = 'en-GB';
            utterance.pitch = 1;
            utterance.rate = 1;
            speechSynth.speak(utterance);
        }

        function generatePronunciationAnalysis() {
            // Show analysis section
            pronunciationIntroMessage.style.display = 'none';
            analysisContent.style.display = 'block';

            // Generate mock scores
            const scoreA = Math.floor(Math.random() * (95 - 60 + 1)) + 60;
            const scoreB = Math.floor(Math.random() * (95 - 60 + 1)) + 60;
            const combined = Math.floor((scoreA + scoreB) / 2);

            combinedAccuracy.textContent = `${combined}%`;
            studentAAccuracy.textContent = `${scoreA}%`;
            studentBAccuracy.textContent = `${scoreB}%`;

            // Generate mock incorrect words
            const commonDifficultWords = [
                "restaurant", "schedule", "comfortable", "pronunciation",
                "epitome", "colonel", "squirrel", "anemone", "rural", "choir"
            ];
            const numIncorrect = Math.floor(Math.random() * (6 - 2 + 1)) + 2; // 2-6 incorrect words
            const shuffledWords = commonDifficultWords.sort(() => 0.5 - Math.random());
            const selectedIncorrectWords = shuffledWords.slice(0, numIncorrect);

            incorrectWordsList.innerHTML = '';
            selectedIncorrectWords.forEach(word => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>${word}</span>
                    <button onclick="speakWord('${word}')"><i class="fas fa-volume-up"></i></button>
                `;
                incorrectWordsList.appendChild(li);
            });

            currentRecordingAnalysis = {
                date: new Date().toISOString(),
                duration: seconds,
                accuracyA: scoreA,
                accuracyB: scoreB,
                audioDataUrl: audioUrl,
                script: currentScript,
                incorrectWords: selectedIncorrectWords
            };
        }

        function saveCurrentRecording() {
            if (!currentRecordingAnalysis) {
                showMessage(scriptMessage, 'No recording analysis to save!', 'error');
                return;
            }

            const recordings = JSON.parse(localStorage.getItem(RECORDINGS_STORAGE_KEY) || '[]');
            recordings.push(currentRecordingAnalysis);
            localStorage.setItem(RECORDINGS_STORAGE_KEY, JSON.stringify(recordings));

            showMessage(scriptMessage, 'Recording and analysis saved successfully!', 'success');
            currentRecordingAnalysis = null; // Clear after saving
            showSection('recordings-library');
        }

        // --- Recordings Library Logic ---

        function loadRecordings() {
            const recordings = JSON.parse(localStorage.getItem(RECORDINGS_STORAGE_KEY) || '[]');
            recordingsTableBody.innerHTML = '';

            if (recordings.length === 0) {
                noRecordingsMessage.style.display = 'block';
                recordingsTable.style.display = 'none';
                return;
            }

            noRecordingsMessage.style.display = 'none';
            recordingsTable.style.display = 'table';

            recordings.forEach((rec, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${new Date(rec.date).toLocaleDateString()}</td>
                    <td>${formatTime(rec.duration)}</td>
                    <td>${rec.accuracyA}%</td>
                    <td>${rec.accuracyB}%</td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-play" data-index="${index}"><i class="fas fa-play"></i></button>
                            <button class="btn btn-analyze" data-index="${index}"><i class="fas fa-chart-bar"></i></button>
                            <button class="btn btn-delete" data-index="${index}"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                `;
                recordingsTableBody.appendChild(tr);
            });

            // Attach event listeners to new buttons
            recordingsTableBody.querySelectorAll('.btn-play').forEach(btn => {
                btn.onclick = (e) => playStoredRecording(e.target.closest('button').dataset.index);
            });
            recordingsTableBody.querySelectorAll('.btn-analyze').forEach(btn => {
                btn.onclick = (e) => viewStoredAnalysis(e.target.closest('button').dataset.index);
            });
            recordingsTableBody.querySelectorAll('.btn-delete').forEach(btn => {
                btn.onclick = (e) => deleteRecording(e.target.closest('button').dataset.index);
            });
        }

        function playStoredRecording(index) {
            const recordings = JSON.parse(localStorage.getItem(RECORDINGS_STORAGE_KEY) || '[]');
            const recording = recordings[index];
            if (recording && recording.audioDataUrl) {
                const audio = new Audio(recording.audioDataUrl);
                audio.play();
            } else {
                alert('Audio data not found for this recording.');
            }
        }

        function viewStoredAnalysis(index) {
            const recordings = JSON.parse(localStorage.getItem(RECORDINGS_STORAGE_KEY) || '[]');
            const recording = recordings[index];
            if (recording) {
                pronunciationIntroMessage.style.display = 'none';
                analysisContent.style.display = 'block';

                combinedAccuracy.textContent = `${Math.floor((recording.accuracyA + recording.accuracyB) / 2)}%`;
                studentAAccuracy.textContent = `${recording.accuracyA}%`;
                studentBAccuracy.textContent = `${recording.accuracyB}%`;

                incorrectWordsList.innerHTML = '';
                recording.incorrectWords.forEach(word => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span>${word}</span>
                        <button onclick="speakWord('${word}')"><i class="fas fa-volume-up"></i></button>
                    `;
                    incorrectWordsList.appendChild(li);
                });

                // Hide save button if viewing old analysis
                const saveBtn = pronunciationAnalysisSection.querySelector('.btn-primary');
                if (saveBtn) saveBtn.style.display = 'none';

                showSection('pronunciation-analysis');
            }
        }

        function deleteRecording(index) {
            if (!confirm('Are you sure you want to delete this recording?')) return;

            let recordings = JSON.parse(localStorage.getItem(RECORDINGS_STORAGE_KEY) || '[]');
            recordings.splice(index, 1); // Remove item at index
            localStorage.setItem(RECORDINGS_STORAGE_KEY, JSON.stringify(recordings));
            loadRecordings(); // Reload the table
        }

        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            loadScript();
            loadRecordings();
            startRecording(); // Initialize microphone access and mediaRecorder on page load
        });

        // Add class to sections on scroll for fade-in effect
        const observer = new IntersectionObserver(entries => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('active');
                }
            });
        }, { threshold: 0.1 }); // Trigger when 10% of the section is visible

        document.querySelectorAll('section:not(#homepage)').forEach(section => {
            observer.observe(section);
        });

    </script>
</body>
</html>