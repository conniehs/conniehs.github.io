<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RolePlayConvo: Interactive Conversation Practice</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #F5F5F5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        #hero {
            background: linear-gradient(to bottom, #800080, #4B0082);
            color: white;
            text-align: center;
            padding: 100px 20px;
        }
        .button {
            background-color: #FF7F50;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            cursor: pointer;
            margin: 10px;
            border-radius: 5px;
            transition: transform 0.2s, opacity 0.2s;
        }
        .button:hover {
            transform: scale(1.05);
        }
        .pulse {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        section {
            margin: 40px 0;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            opacity: 0;
            animation: fadeIn 0.5s forwards;
        }
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        #upload textarea {
            width: 100%;
            height: 200px;
            margin: 10px 0;
        }
        .tabs {
            display: flex;
            justify-content: center;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: #ddd;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
        }
        .tab.active {
            background: #FF7F50;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .mic-button {
            font-size: 50px;
            cursor: pointer;
            margin: 20px auto;
            display: block;
        }
        canvas {
            width: 100%;
            height: 100px;
            background: #eee;
        }
        .hidden {
            display: none;
        }
        .analysis-item {
            margin: 10px 0;
        }
        .tts-button {
            background: #FF7F50;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
        }
        #library ul {
            list-style: none;
            padding: 0;
        }
        #library li {
            margin: 10px 0;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 5px;
        }
        @media (max-width: 768px) {
            .button {
                width: 100%;
                margin: 10px 0;
            }
            #hero {
                padding: 50px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <section id="hero">
            <h1>Welcome to RolePlayConvo! Enhance your speaking skills through engaging conversations.</h1>
            <button class="button" onclick="scrollToSection('upload')">Start New Conversation</button>
            <button class="button" onclick="scrollToSection('library')">View My Recordings</button>
        </section>

        <section id="upload">
            <h2>1. Script Upload Section</h2>
            <input type="file" id="scriptFile" accept=".txt">
            <textarea id="scriptPreview" readonly></textarea>
            <button class="button" onclick="saveScript()">Save Script & Continue</button>
            <p id="uploadSuccess" class="hidden">Script saved! Ready for recording.</p>
        </section>

        <section id="recording">
            <h2>2. Recording Studio</h2>
            <div class="tabs">
                <div class="tab active" onclick="switchTab('a')">Student A</div>
                <div class="tab" onclick="switchTab('b')">Student B</div>
            </div>
            <div id="tab-a" class="tab-content active">
                <p id="micMessageA">Allow microphone access</p>
                <div id="micButtonA" class="mic-button pulse" onclick="toggleRecording('a')">ðŸŽ¤</div>
                <canvas id="waveformA"></canvas>
                <p id="timerA">00:00</p>
                <button class="button hidden" id="playA">Play</button>
                <button class="button hidden" id="rerecordA">Re-record</button>
                <button class="button hidden" id="downloadA">Download MP3</button>
            </div>
            <div id="tab-b" class="tab-content">
                <p id="micMessageB">Allow microphone access</p>
                <div id="micButtonB" class="mic-button pulse" onclick="toggleRecording('b')">ðŸŽ¤</div>
                <canvas id="waveformB"></canvas>
                <p id="timerB">00:00</p>
                <button class="button hidden" id="playB">Play</button>
                <button class="button hidden" id="rerecordB">Re-record</button>
                <button class="button hidden" id="downloadB">Download MP3</button>
            </div>
            <button class="button" onclick="analyzeRecordings()" id="analyzeButton" class="hidden">Analyze Pronunciation</button>
        </section>

        <section id="analysis" class="hidden">
            <h2>3. Pronunciation Analysis</h2>
            <p>Pronunciation Accuracy: <span id="combinedScore"></span>%</p>
            <p>Student A: <span id="scoreA"></span>% | Student B: <span id="scoreB"></span>%</p>
            <h3>Incorrect words (click to hear correct UK pronunciation):</h3>
            <div id="incorrectWords"></div>
            <h3>Practice these phrases:</h3>
            <div id="practicePhrases"></div>
        </section>

        <section id="library">
            <h2>4. Recordings Library</h2>
            <ul id="recordingsList"></ul>
        </section>
    </div>

    <script>
        let scriptText = '';
        let aText = '';
        let bText = '';
        let mediaRecorderA, mediaRecorderB;
        let audioChunksA = [], audioChunksB = [];
        let audioBlobA, audioBlobB;
        let audioUrlA, audioUrlB;
        let isRecordingA = false, isRecordingB = false;
        let timerIntervalA, timerIntervalB;
        let timeA = 0, timeB = 0;
        let stream;
        let audioContext, analyser, scriptProcessor;
        let currentTab = 'a';
        let recognitionA, recognitionB;
        let transcriptA = '', transcriptB = '';
        let sessions = JSON.parse(localStorage.getItem('sessions')) || [];
        let currentSession = { date: new Date().toISOString(), script: '' };

        function scrollToSection(id) {
            document.getElementById(id).scrollIntoView({ behavior: 'smooth' });
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`.tab[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
        }

        document.getElementById('scriptFile').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    scriptText = ev.target.result;
                    document.getElementById('scriptPreview').value = scriptText;
                };
                reader.readAsText(file);
            }
        });

        function saveScript() {
            if (scriptText) {
                localStorage.setItem('currentScript', scriptText);
                document.getElementById('uploadSuccess').classList.remove('hidden');
                parseScript(scriptText);
                currentSession.script = scriptText;
                scrollToSection('recording');
            }
        }

        function parseScript(text) {
            const lines = text.split('\n');
            aText = lines.filter(l => l.toLowerCase().startsWith('student a:') || l.toLowerCase().startsWith('a:')).map(l => l.split(':')[1].trim()).join(' ');
            bText = lines.filter(l => l.toLowerCase().startsWith('student b:') || l.toLowerCase().startsWith('b:')).map(l => l.split(':')[1].trim()).join(' ');
        }

        async function initMic() {
            if (!stream) {
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    document.getElementById('micMessageA').textContent = 'Ready to record!';
                    document.getElementById('micMessageB').textContent = 'Ready to record!';
                } catch (err) {
                    console.error('Mic access denied', err);
                }
            }
        }

        function setupWaveform(canvasId) {
            audioContext = new AudioContext();
            analyser = audioContext.createAnalyser();
            const source = audioContext.createMediaStreamSource(stream);
            source.connect(analyser);
            analyser.fftSize = 2048;
            scriptProcessor = audioContext.createScriptProcessor(2048, 1, 1);
            analyser.connect(scriptProcessor);
            scriptProcessor.connect(audioContext.destination);
            scriptProcessor.onaudioprocess = () => drawWaveform(canvasId);
        }

        function drawWaveform(canvasId) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            const data = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteTimeDomainData(data);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.lineWidth = 2;
            ctx.strokeStyle = '#FF7F50';
            ctx.beginPath();
            const sliceWidth = canvas.width / data.length;
            let x = 0;
            for (let i = 0; i < data.length; i++) {
                const v = data[i] / 128.0;
                const y = v * canvas.height / 2;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
                x += sliceWidth;
            }
            ctx.lineTo(canvas.width, canvas.height / 2);
            ctx.stroke();
            requestAnimationFrame(() => drawWaveform(canvasId));
        }

        async function toggleRecording(tab) {
            await initMic();
            if (!stream) return;
            const isRecording = tab === 'a' ? isRecordingA : isRecordingB;
            if (!isRecording) {
                setupWaveform(`waveform${tab.toUpperCase()}`);
                const recorder = new MediaRecorder(stream);
                if (tab === 'a') {
                    mediaRecorderA = recorder;
                    audioChunksA = [];
                    timeA = 0;
                    transcriptA = '';
                } else {
                    mediaRecorderB = recorder;
                    audioChunksB = [];
                    timeB = 0;
                    transcriptB = '';
                }
                recorder.ondataavailable = (e) => (tab === 'a' ? audioChunksA : audioChunksB).push(e.data);
                recorder.onstop = () => saveRecording(tab);
                recorder.start();
                startTimer(tab);
                startRecognition(tab);
                document.getElementById(`micMessage${tab.toUpperCase()}`).textContent = 'Recording: [00:00]';
                document.getElementById(`micButton${tab.toUpperCase()}`).classList.remove('pulse');
                if (tab === 'a') isRecordingA = true;
                else isRecordingB = true;
            } else {
                (tab === 'a' ? mediaRecorderA : mediaRecorderB).stop();
                stopTimer(tab);
                stopRecognition(tab);
                document.getElementById(`micMessage${tab.toUpperCase()}`).textContent = 'Ready to record!';
                document.getElementById(`micButton${tab.toUpperCase()}`).classList.add('pulse');
                showControls(tab);
                if (tab === 'a') isRecordingA = false;
                else isRecordingB = false;
                checkBothRecorded();
            }
        }

        function startTimer(tab) {
            const timerEl = document.getElementById(`timer${tab.toUpperCase()}`);
            const interval = setInterval(() => {
                const time = tab === 'a' ? ++timeA : ++timeB;
                const min = Math.floor(time / 60).toString().padStart(2, '0');
                const sec = (time % 60).toString().padStart(2, '0');
                timerEl.textContent = `${min}:${sec}`;
                document.getElementById(`micMessage${tab.toUpperCase()}`).textContent = `Recording: [${min}:${sec}]`;
            }, 1000);
            if (tab === 'a') timerIntervalA = interval;
            else timerIntervalB = interval;
        }

        function stopTimer(tab) {
            clearInterval(tab === 'a' ? timerIntervalA : timerIntervalB);
        }

        function saveRecording(tab) {
            const chunks = tab === 'a' ? audioChunksA : audioChunksB;
            const blob = new Blob(chunks, { type: 'audio/webm' });
            const url = URL.createObjectURL(blob);
            if (tab === 'a') {
                audioBlobA = blob;
                audioUrlA = url;
                currentSession.audioA = blobToBase64(blob);
                currentSession.durationA = timeA;
            } else {
                audioBlobB = blob;
                audioUrlB = url;
                currentSession.audioB = blobToBase64(blob);
                currentSession.durationB = timeB;
            }
        }

        function blobToBase64(blob) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.readAsDataURL(blob);
            });
        }

        function showControls(tab) {
            document.getElementById(`play${tab.toUpperCase()}`).classList.remove('hidden');
            document.getElementById(`rerecord${tab.toUpperCase()}`).classList.remove('hidden');
            document.getElementById(`download${tab.toUpperCase()}`).classList.remove('hidden');
        }

        document.getElementById('playA').onclick = () => new Audio(audioUrlA).play();
        document.getElementById('playB').onclick = () => new Audio(audioUrlB).play();
        document.getElementById('rerecordA').onclick = () => resetRecording('a');
        document.getElementById('rerecordB').onclick = () => resetRecording('b');
        document.getElementById('downloadA').onclick = () => downloadAudio('a');
        document.getElementById('downloadB').onclick = () => downloadAudio('b');

        function resetRecording(tab) {
            document.getElementById(`play${tab.toUpperCase()}`).classList.add('hidden');
            document.getElementById(`rerecord${tab.toUpperCase()}`).classList.add('hidden');
            document.getElementById(`download${tab.toUpperCase()}`).classList.add('hidden');
            if (tab === 'a') {
                audioChunksA = [];
                timeA = 0;
                document.getElementById('timerA').textContent = '00:00';
            } else {
                audioChunksB = [];
                timeB = 0;
                document.getElementById('timerB').textContent = '00:00';
            }
            checkBothRecorded();
        }

        function downloadAudio(tab) {
            const a = document.createElement('a');
            a.href = tab === 'a' ? audioUrlA : audioUrlB;
            a.download = `recording_${tab}.webm`;  // Note: webm, as MP3 not natively supported
            a.click();
        }

        function checkBothRecorded() {
            if (audioBlobA && audioBlobB) {
                document.getElementById('analyzeButton').classList.remove('hidden');
            } else {
                document.getElementById('analyzeButton').classList.add('hidden');
            }
        }

        function startRecognition(tab) {
            if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'en-US';  // For transcription
                recognition.onresult = (e) => {
                    const transcript = Array.from(e.results).map(r => r[0].transcript).join(' ');
                    if (tab === 'a') transcriptA = transcript;
                    else transcriptB = transcript;
                };
                recognition.start();
                if (tab === 'a') recognitionA = recognition;
                else recognitionB = recognition;
            }
        }

        function stopRecognition(tab) {
            if (tab === 'a' && recognitionA) recognitionA.stop();
            else if (recognitionB) recognitionB.stop();
        }

        function analyzeRecordings() {
            let scoreA, scoreB, combined;
            let incorrect = ['restaurant', 'schedule', 'comfortable'];
            if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
                scoreA = calculateAccuracy(aText, transcriptA);
                scoreB = calculateAccuracy(bText, transcriptB);
                combined = Math.round((scoreA + scoreB) / 2);
                incorrect = findIncorrect(aText + ' ' + bText, transcriptA + ' ' + transcriptB);
            } else {
                scoreA = 85;
                scoreB = 89;
                combined = 87;
            }
            document.getElementById('combinedScore').textContent = combined;
            document.getElementById('scoreA').textContent = scoreA;
            document.getElementById('scoreB').textContent = scoreB;
            const incorrectDiv = document.getElementById('incorrectWords');
            incorrectDiv.innerHTML = '';
            incorrect.forEach(word => {
                const div = document.createElement('div');
                div.className = 'analysis-item';
                div.textContent = `${word} â†’ `;
                const btn = document.createElement('button');
                btn.className = 'tts-button';
                btn.textContent = 'Play';
                btn.onclick = () => playTTS(word);
                div.appendChild(btn);
                incorrectDiv.appendChild(div);
            });
            const phrases = ['Can I have the menu, please?', "I'd like to make a reservation."];
            const phrasesDiv = document.getElementById('practicePhrases');
            phrasesDiv.innerHTML = '';
            phrases.forEach(phrase => {
                const div = document.createElement('div');
                div.textContent = phrase;
                phrasesDiv.appendChild(div);
            });
            document.getElementById('analysis').classList.remove('hidden');
            scrollToSection('analysis');
            currentSession.scoreA = scoreA;
            currentSession.scoreB = scoreB;
            saveSession();
        }

        function calculateAccuracy(expected, transcript) {
            const expectedWords = new Set(expected.toLowerCase().split(/\s+/).filter(w => w));
            const transWords = new Set(transcript.toLowerCase().split(/\s+/).filter(w => w));
            const intersection = new Set([...expectedWords].filter(w => transWords.has(w)));
            const union = new Set([...expectedWords, ...transWords]);
            const jaccard = intersection.size / union.size;
            return Math.round(jaccard * 100);
        }

        function findIncorrect(expected, transcript) {
            const expectedWords = expected.toLowerCase().split(/\s+/).filter(w => w);
            const transWords = transcript.toLowerCase().split(/\s+/).filter(w => w);
            return expectedWords.filter((w, i) => w !== transWords[i]);
        }

        function playTTS(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-GB';
            const voices = speechSynthesis.getVoices();
            const ukVoice = voices.find(v => v.lang === 'en-GB');
            if (ukVoice) utterance.voice = ukVoice;
            speechSynthesis.speak(utterance);
        }

        function saveSession() {
            sessions.push(currentSession);
            localStorage.setItem('sessions', JSON.stringify(sessions));
            loadLibrary();
            // Reset for new
            currentSession = { date: new Date().toISOString(), script: '' };
            audioBlobA = audioBlobB = null;
            document.getElementById('analyzeButton').classList.add('hidden');
        }

        function loadLibrary() {
            const list = document.getElementById('recordingsList');
            list.innerHTML = '';
            sessions.forEach((s, i) => {
                const li = document.createElement('li');
                const date = new Date(s.date).toLocaleString();
                const duration = ((s.durationA || 0) + (s.durationB || 0)) / 60;
                li.textContent = `${date} | Duration: ${duration.toFixed(1)} min | A%: ${s.scoreA || '-'} | B%: ${s.scoreB || '-'} `;
                const playBtn = document.createElement('button');
                playBtn.className = 'button';
                playBtn.textContent = 'Play';
                playBtn.onclick = () => {
                    new Audio(s.audioA).play();  // Play A, then B could be sequenced but simple
                    setTimeout(() => new Audio(s.audioB).play(), (s.durationA || 0) * 1000);
                };
                li.appendChild(playBtn);
                const analyzeBtn = document.createElement('button');
                analyzeBtn.className = 'button';
                analyzeBtn.textContent = 'Analyze';
                analyzeBtn.onclick = () => {
                    document.getElementById('combinedScore').textContent = Math.round((s.scoreA + s.scoreB) / 2);
                    document.getElementById('scoreA').textContent = s.scoreA;
                    document.getElementById('scoreB').textContent = s.scoreB;
                    // Assume same incorrect for simplicity
                    document.getElementById('analysis').classList.remove('hidden');
                    scrollToSection('analysis');
                };
                li.appendChild(analyzeBtn);
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'button';
                deleteBtn.textContent = 'Delete';
                deleteBtn.onclick = () => {
                    sessions.splice(i, 1);
                    localStorage.setItem('sessions', JSON.stringify(sessions));
                    loadLibrary();
                };
                li.appendChild(deleteBtn);
                list.appendChild(li);
            });
        }

        // Load on start
        loadLibrary();
    </script>
</body>
</html>
